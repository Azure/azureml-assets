# This workflow triggers the Azure DevOps "AzureML-Assets-Unified-OneBranch" pipeline
# when the "assets-release" workflow completes successfully on the main branch.
#
# Required secrets:
# - AZURE_DEVOPS_ORG: Azure DevOps organization name
# - AZURE_DEVOPS_PROJECT: Azure DevOps project name  
# - AZURE_DEVOPS_PAT: Personal Access Token with Build (Read & execute) permissions
#
# Pipeline configuration:
# - Branch: main
# - Variables: pattern=environment/llm-rag.*/.+
#
# See .github/workflows/TRIGGER_ONEBRANCH_README.md for more details.

name: Trigger OneBranch Pipeline

on:
  workflow_run:
    workflows: ["assets-release"]
    types:
      - completed
    branches:
      - main

jobs:
  trigger-onebranch:
    name: Trigger AzureML-Assets-Unified-OneBranch Pipeline
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Trigger Azure DevOps Pipeline
        env:
          AZURE_DEVOPS_ORG: ${{ secrets.AZURE_DEVOPS_ORG }}
          AZURE_DEVOPS_PROJECT: ${{ secrets.AZURE_DEVOPS_PROJECT }}
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          PIPELINE_NAME: AzureML-Assets-Unified-OneBranch
        run: |
          echo "Triggering Azure DevOps pipeline: $PIPELINE_NAME"
          echo "Branch: main"
          echo "Pattern: environment/llm-rag.*/.+"
          
          # Validate required secrets
          if [ -z "$AZURE_DEVOPS_ORG" ] || [ -z "$AZURE_DEVOPS_PROJECT" ] || [ -z "$AZURE_DEVOPS_PAT" ]; then
            echo "::error::Required secrets are not configured. Please set AZURE_DEVOPS_ORG, AZURE_DEVOPS_PROJECT, and AZURE_DEVOPS_PAT"
            exit 1
          fi
          
          # Get pipeline ID
          RESPONSE=$(curl -s -f \
            -u ":$AZURE_DEVOPS_PAT" \
            "https://dev.azure.com/$AZURE_DEVOPS_ORG/$AZURE_DEVOPS_PROJECT/_apis/pipelines?api-version=7.1" 2>&1)
          
          CURL_EXIT=$?
          if [ $CURL_EXIT -ne 0 ]; then
            echo "::error::Failed to connect to Azure DevOps API (curl exit code: $CURL_EXIT)"
            echo "$RESPONSE"
            exit 1
          fi
          
          # Check if jq is available
          if ! command -v jq &> /dev/null; then
            echo "::error::jq is not installed"
            exit 1
          fi
          
          PIPELINE_ID=$(echo "$RESPONSE" | jq -r ".value[] | select(.name == \"$PIPELINE_NAME\") | .id")
          
          if [ -z "$PIPELINE_ID" ] || [ "$PIPELINE_ID" == "null" ]; then
            echo "::error::Pipeline '$PIPELINE_NAME' not found in project $AZURE_DEVOPS_PROJECT"
            echo "Available pipelines:"
            echo "$RESPONSE" | jq -r '.value[].name' | head -10
            exit 1
          fi
          
          echo "Found pipeline ID: $PIPELINE_ID"
          
          # Trigger pipeline with variables
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -u ":$AZURE_DEVOPS_PAT" \
            -H "Content-Type: application/json" \
            "https://dev.azure.com/$AZURE_DEVOPS_ORG/$AZURE_DEVOPS_PROJECT/_apis/pipelines/$PIPELINE_ID/runs?api-version=7.1" \
            -d '{
              "resources": {
                "repositories": {
                  "self": {
                    "refName": "refs/heads/main"
                  }
                }
              },
              "variables": {
                "pattern": {
                  "value": "environment/llm-rag.*/.+"
                }
              }
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          # Validate HTTP_CODE is numeric
          if ! [[ "$HTTP_CODE" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid HTTP response received"
            echo "$RESPONSE"
            exit 1
          fi
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            RUN_ID=$(echo "$BODY" | jq -r '.id')
            RUN_URL=$(echo "$BODY" | jq -r '.url')
            echo "âœ“ Pipeline triggered successfully"
            echo "Run ID: $RUN_ID"
            echo "Run URL: $RUN_URL"
          else
            echo "::error::Failed to trigger pipeline. HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi
