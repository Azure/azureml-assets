$schema: https://azuremlschemas.azureedge.net/latest/pipelineComponent.schema.json
name: medimage_insight_ft_pipeline
version: 0.0.1.yesh5
type: pipeline
display_name: Medical Image Insight Classification Adapter Pipeline
description: Pipeline Component to finetune Hugging Face pretrained models for chat completion task. The component supports optimizations such as LoRA, Deepspeed and ONNXRuntime for performance enhancement. See [docs](https://aka.ms/azureml/components/chat_completion_pipeline) to learn more.

inputs:
  instance_type_preprocess:
      type: string
      optional: true
      default: Standard_d12_v2
      description: Instance type to be used for preprocess component in case of serverless compute, eg. standard_d12_v2. 
        The parameter compute_preprocess must be set to 'serverless' for instance_type to be used
  instance_type_finetune:
    type: string
    optional: true
    default: Standard_nc24rs_v3
    description: Instance type to be used for finetune component in case of serverless compute, eg. standard_nc24rs_v3. 
      The parameter compute_finetune must be set to 'serverless' for instance_type to be used
  compute_preprocess:
    type: string
    optional: true
    default: serverless
    description: compute to be used for preprocess eg. provide 'FT-Cluster' if your
      compute is named 'FT-Cluster'. Special characters like \ and ' are invalid in the parameter value.
      If compute cluster name is provided, instance_type field will be ignored and the respective cluster will be used
  compute_finetune:
    type: string
    optional: true
    default: serverless
    description: compute to be used for finetune eg. provide 'FT-Cluster' if your
      compute is named 'FT-Cluster'. Special characters like \ and ' are invalid in the parameter value.
      If compute cluster name is provided, instance_type field will be ignored and the respective cluster will be used
  mlflow_model_path:
    type: uri_folder
    optional: false
    description: Path to the MLflow model to be used.

  zeroshot_path:
    type: uri_file
    optional: false
    description: Path to the zeroshot data file.
    mode: rw_mount

  test_train_split_csv_path:
    type: uri_file
    optional: false
    description: Path to the CSV file containing test-train split information.
    mode: rw_mount

  train_dataloader_batch_size:
    type: integer
    min: 1
    default: 8
    optional: true
    description: Batch size for the training dataloader.

  validation_dataloader_batch_size:
    type: integer
    min: 1
    default: 1
    optional: true
    description: Batch size for the validation dataloader.

  train_dataloader_workers:
    type: integer
    min: 0
    default: 2
    optional: true
    description: Number of workers for the training dataloader.

  validation_dataloader_workers:
    type: integer
    min: 0
    default: 2
    optional: true
    description: Number of workers for the validation dataloader.

  output_classes:
    type: integer
    min: 1
    default: 5
    optional: true
    description: Number of output classes.

  hidden_dimensions:
    type: integer
    min: 1
    default: 512
    optional: true
    description: Number of hidden dimensions.

  input_channels:
    type: integer
    min: 1
    default: 1024
    optional: true
    description: Number of input channels.

  learning_rate:
    type: number
    default: 0.0003
    optional: true
    description: Learning rate for training.

  max_epochs:
    type: integer
    min: 1
    default: 10
    optional: true
    description: Maximum number of epochs for training.

outputs:
  output_model_path:
    type: uri_folder
    description: Path to save the output model.
    mode: rw_mount

jobs:
  medical_image_embedding_datapreprocessing:
    type: command
    component: azureml:medical_image_embedding_datapreprocessing:0.0.1.yesh5
    compute: '${{parent.inputs.compute_finetune}}'
    resources:
      instance_type: '${{parent.inputs.instance_type_preprocess}}'
    inputs:
      mlflow_model_path: '${{parent.inputs.mlflow_model_path}}'
      zeroshot_path: '${{parent.inputs.zeroshot_path}}'
      test_train_split_csv_path: '${{parent.inputs.test_train_split_csv_path}}'
  medimgage_adapter_finetune:
    type: command
    component: azureml:medimgage_adapter_finetune:0.0.1.yesh1
    compute: '${{parent.inputs.compute_finetune}}'
    resources:
      instance_type: '${{parent.inputs.instance_type_finetune}}'
    inputs:
      train_data_path: '${{parent.jobs.medical_image_embedding_datapreprocessing.outputs.output_train_pkl}}'
      validation_data_path: '${{parent.jobs.medical_image_embedding_datapreprocessing.outputs.output_validation_pkl}}'
      train_dataloader_batch_size: '${{parent.inputs.train_dataloader_batch_size}}'
      validation_dataloader_batch_size: '${{parent.inputs.validation_dataloader_batch_size}}'
      train_dataloader_workers: '${{parent.inputs.train_dataloader_workers}}'
      validation_dataloader_workers: '${{parent.inputs.validation_dataloader_workers}}'
      output_classes: '${{parent.inputs.output_classes}}'
      hidden_dimensions: '${{parent.inputs.hidden_dimensions}}'
      input_channels: '${{parent.inputs.input_channels}}'
      learning_rate: '${{parent.inputs.learning_rate}}'
      max_epochs: '${{parent.inputs.max_epochs}}'
    outputs:
      output_model_path: '${{parent.outputs.output_model_path}}'