$schema: https://azuremlschemas.azureedge.net/latest/pipelineComponent.schema.json
type: pipeline

name: validate_model_inference
display_name: Validate Model Inference
description: deploy a model and validate it using a sample payload
version: 0.0.1

inputs:
  compute:
    type: string
    optional: true
    default: serverless
    description: Compute for model deployment and inferencing
  
  instance_type:
    type: string
    optional: true
    enum:
      - Standard_DS1_v2
      - Standard_DS2_v2
      - Standard_DS3_v2
      - Standard_DS4_v2
      - Standard_DS5_v2
      - Standard_F2s_v2
      - Standard_F4s_v2
      - Standard_F8s_v2
      - Standard_F16s_v2
      - Standard_F32s_v2
      - Standard_F48s_v2
      - Standard_F64s_v2
      - Standard_F72s_v2
      - Standard_FX24mds
      - Standard_FX36mds
      - Standard_FX48mds
      - Standard_E2s_v3
      - Standard_E4s_v3
      - Standard_E8s_v3
      - Standard_E16s_v3
      - Standard_E32s_v3
      - Standard_E48s_v3
      - Standard_E64s_v3
      - Standard_NC4as_T4_v3
      - Standard_NC6s_v2
      - Standard_NC6s_v3
      - Standard_NC8as_T4_v3
      - Standard_NC12s_v2
      - Standard_NC12s_v3
      - Standard_NC16as_T4_v3
      - Standard_NC24s_v2
      - Standard_NC24s_v3
      - Standard_NC24rs_v3
      - Standard_NC64as_T4_v3
      - Standard_ND40rs_v2
      - Standard_ND96asr_v4
      - Standard_ND96amsr_A100_v4
    default: Standard_NC6s_v3
    description: Compute instance type to deploy model. Make sure that instance type is available and have enough quota available.

  instance_count:
    type: integer
    optional: true
    default: 1
    description: Number of instances you want to use for deployment. Make sure instance type have enough quota available.

  model_id:
    type: string
    optional: false
    description: |
      Asset ID of the model registered in workspace/registry.
      Registry - azureml://registries/<registry-name>/models/<model-name>/versions/<version>
      Workspace - azureml:<model-name>:<version>

  model_name:
    type: string
    optional: false
    description: Name of the model to validate.

  model_version:
    type: integer
    optional: false
    description: Model onboarding version (e.g., 5)

  publisher_name:
    type: string
    optional: false
    description: Name of the model publisher (e.g., ContosoAI)

  selfserve_base_url:
    type: string
    optional: true
    default: "https://int.api.azureml-test.ms"
    description: Base URL of the model publisher self-serve API

  sku:
    type: string
    optional: true
    default: "Standard_NC24ads_A100_v4"
    description: SKU of the deployed model endpoint.

  inference_payload:
    type: string
    optional: false
    description: JSON payload which would be used to validate deployment

  endpoint_name:
    type: string
    optional: true
    description: Name of the endpoint

  deployment_name:
    type: string
    optional: true
    default: default
    description: Name of the deployment

  validation_id:
    type: string
    optional: true
    description: ID of the validation run (used for updating status in self-serve)

  inference_response:
    type: string
    optional: true
    description: JSON file containing the expected inference response.

# Pipeline outputs
outputs:
  validation_results:
    description: Output file containing the validation results.
    type: uri_folder

jobs:
  online_deployment_model:
    type: command
    component: azureml:deploy_model:0.0.12
    compute: ${{parent.inputs.compute}}
    inputs:
      model_id: ${{parent.inputs.model_id}}
      inference_payload_str: ${{parent.inputs.inference_payload}}
      endpoint_name: ${{parent.inputs.endpoint_name}}
      deployment_name: ${{parent.inputs.deployment_name}}
      instance_type: ${{parent.inputs.instance_type}}
      instance_count: ${{parent.inputs.instance_count}}
    outputs:
      model_deployment_details:
        type: uri_file
      model_inference_response:
        type: uri_file

  run_inference_validation:
    type: command
    component: azureml:run_inference_validation:0.0.1
    inputs:
      validation_id: ${{parent.inputs.validation_id}}
      sku: ${{parent.inputs.instance_type}}
      inference_payload: ${{parent.inputs.inference_payload}}
      expected_response: ${{parent.inputs.inference_response}}
      inference_response: ${{parent.jobs.online_deployment_model.outputs.model_inference_response}}
    outputs:
      validation_results: ${{parent.outputs.validation_results}}

  delete_endpoints:
    type: command
    component: azureml:delete_endpoint:0.0.7
    inputs:
      model_deployment_details: ${{parent.jobs.online_deployment_model.outputs.model_deployment_details}}
      endpoint_name: ${{parent.inputs.endpoint_name}}
    compute: ${{parent.inputs.compute}}

  publish_results:
    type: command
    component: azureml:publish_validation_results_selfserve:0.0.1
    inputs:
      publisher_name: ${{parent.inputs.publisher_name}}
      model_name: ${{parent.inputs.model_name}}
      model_version: ${{parent.inputs.model_version}}
      sku: ${{parent.inputs.instance_type}}
      validation_id: ${{parent.inputs.validation_id}}
      selfserve_base_url: ${{parent.inputs.selfserve_base_url}}
      metrics_storage_uri: ${{parent.jobs.run_inference_validation.outputs.metrics_storage_uri}}
