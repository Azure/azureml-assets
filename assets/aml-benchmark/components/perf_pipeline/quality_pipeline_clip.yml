$schema: https://azuremlschemas.azureedge.net/latest/pipelineJob.schema.json
type: pipeline
display_name: clip-quality
experiment_name: clip_quality_pipeline
description: benchmark_clip
jobs:
  endpoint:
    type: pipeline
    component: ../batch-benchmark-inference/spec.yaml
    inputs:
      input_dataset:
        type: uri_file
        path: ./output_jsonls/Flowers-101_processed.jsonl
      label_column_name: label
      batch_input_pattern: '{
        "input_data": {
          "columns": [
            "image", "text"
          ],
          "index": [0],
          "data": [
            ["###<image>", "###<text>"]
          ]
        },
        "params": {}
      }'
      model_type: vision_oss
      endpoint_url: https://clip-base-gpu.eastus.inference.ml.azure.com/score
      is_performance_test: false
      deployment_name: openai-clip-vit-base-patch32-5
      connections_name: clip-base-gpu-2
      handle_response_failure: use_fallback
      ensure_ascii: false
      initial_worker_count: 1
      max_worker_count: 1
      instance_count: 1
      max_concurrency_per_instance: 1
      debug_mode: true
    outputs:
      predictions:
        type: uri_file
        path: azureml://datastores/${{default_datastore}}/paths/azureml/${{name}}/${{output_name}}.jsonl
      performance_metadata:
        type: uri_file
        path: azureml://datastores/${{default_datastore}}/paths/azureml/${{name}}/${{output_name}}.jsonl
      ground_truth:
        type: uri_file
        path: azureml://datastores/${{default_datastore}}/paths/azureml/${{name}}/${{output_name}}.jsonl
  quality:
    type: command
    component: azureml://registries/azureml/components/compute_metrics/labels/latest
    limits:
      timeout: 900
    inputs:
      task: image-classification
      prediction:
        type: uri_folder
        path: ${{parent.jobs.endpoint.outputs.predictions}}
      ground_truth:
        type: uri_folder
        path: ${{parent.jobs.endpoint.outputs.ground_truth}}
    outputs:
      evaluation_result:
        type: uri_file
        path: azureml://datastores/${{default_datastore}}/paths/azureml/${{name}}/${{output_name}}.json
  aggregator:
    type: command
    component: azureml://registries/azureml/components/benchmark_result_aggregator/labels/latest
    limits:
      timeout: 900
    inputs:
      quality_metrics:
        type: uri_folder
        path: ${{parent.jobs.quality.outputs.evaluation_result}}
    outputs:
      benchmark_result:
        type: uri_file
        path: azureml://datastores/${{default_datastore}}/paths/azureml/${{name}}/${{output_name}}.json
tags:
  workflow: vision_benchmark
  run_type: private
properties:
  _azureml.evaluation_run: Benchmark
settings:
  continue_on_step_failure: true
  force_rerun: false
  default_compute: azureml:serverless