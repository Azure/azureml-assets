$schema: https://azuremlschemas.azureedge.net/latest/pipelineComponent.schema.json
type: pipeline

name: import_model
display_name: Import model
description: Import a model into a workspace or a registry
version: 0.0.1

# Pipeline inputs
inputs:
  # pipeline specific compute
  compute:
    type: string
    description: Compute to run pipeline job

  ## Inputs for download model
  model_source:
    type: string
    description: Storage containers from where model will be sourced from.
    default: Huggingface
    enum:
      - AzureBlob
      - GIT
      - Huggingface

  model_id:
    type: string
    description: A valid model id for the model source selected. For example you can specify `bert-base-uncased` for importing HuggingFace bert base uncased model. Please specify the complete URL if **GIT** or **AzureBlob** is selected in `model_source`

  ## Inputs for the MlFLow conversion
  license_file_path:
    type: uri_file
    description: Path to the license file
    optional: true

  ## Inputs for model local validation
  test_data_path:
    type: uri_file
    optional: true
    description: Test dataset for model inferencing

  test_data_column_rename_map:
    type: string
    optional: true
    description: |
      Provide mapping of dataset column names that should be renamed before inferencing.
      eg: col1:ren1; col2:ren2; col3:ren3

  ## Inputs for Model registration
  custom_model_name:
    type: string
    optional: true
    description: Model name to use in the registration. If name already exists, the version will be auto incremented

  model_version:
    type: string
    optional: true
    description: Model version in workspace/registry. If the same model name and version exists, the version will be auto incremented

  model_description:
    type: string
    optional: true
    description: Description of the model that will be shown in AzureML registry or workspace

  registry_name:
    type: string
    optional: true
    description: Name of the AzureML asset registry where the model will be registered. Model will be registered in a workspace if this is unspecified

  model_metadata:
    type: uri_file
    optional: true
    description: A JSON or a YAML file that contains model metadata confirming to Model V2 [contract](https://azuremlschemas.azureedge.net/latest/model.schema.json)

# Pipeline outputs
outputs:
  mlflow_model_folder:
    description: Output path for the converted MLFlow model.
    type: mlflow_model

  model_registration_details:
    description: Output file which captures transformations applied above and registration details in JSON file.
    type: uri_file

jobs:
  download_model:
    component: azureml:download_model:0.0.1
    compute: ${{parent.inputs.compute}}
    inputs:
      model_source: ${{parent.inputs.model_source}}
      model_id: ${{parent.inputs.model_id}}
    outputs:
      model_download_metadata:
        type: uri_file
      model_output:
        type: uri_folder

  convert_model_to_mlflow:
    component: azureml:convert_model_to_mlflow:0.0.1
    compute: ${{parent.inputs.compute}}
    inputs:
      license_file_path: ${{parent.inputs.license_file_path}}
      model_download_metadata: ${{parent.jobs.download_model.outputs.model_download_metadata}}
      model_path: ${{parent.jobs.download_model.outputs.model_output}}
    outputs:
      mlflow_model_folder: ${{parent.outputs.mlflow_model_folder}}
      model_import_job_path:
        type: uri_file

  mlflow_model_local_validation:
    component: azureml:mlflow_model_local_validation:0.0.1
    compute: ${{parent.inputs.compute}}
    inputs:
      model_path: ${{parent.jobs.mlflow_convert_model.outputs.mlflow_model_folder}}
      test_data_path: ${{parent.inputs.test_data_path}}
      column_rename_map: ${{parent.inputs.test_data_column_rename_map}}
    outputs:
      mlflow_model_folder:
        type: mlflow_model

  register_model:
    component: azureml:register_model:0.0.1
    compute: ${{parent.inputs.compute}}
    inputs:
      model_name: ${{parent.inputs.custom_model_name}}
      model_version: ${{parent.inputs.model_version}}
      model_description: ${{parent.inputs.model_description}}
      registry_name: ${{parent.inputs.registry_name}}
      model_metadata: ${{parent.inputs.model_metadata}}
      model_type: mlflow_model
      model_download_metadata: ${{parent.jobs.download_model.outputs.model_download_metadata}}
      model_path: ${{parent.jobs.mlflow_model_local_validation.outputs.mlflow_model_folder}}
      model_import_job_path: ${{parent.jobs.mlflow_convert_model.outputs.model_import_job_path}}
    outputs:
      registration_details: ${{parent.outputs.model_registration_details}}

tags:
    Preview: ""
